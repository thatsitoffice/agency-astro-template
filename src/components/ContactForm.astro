---
// Turnstile Site Key aus Environment Variable
const turnstileSiteKey = import.meta.env.PUBLIC_TURNSTILE_SITE_KEY || '';
---

<form class="contact-form" id="contact-form" novalidate>
  <div class="form-group">
    <label for="name" class="form-label">
      Name <span class="required">*</span>
    </label>
    <input
      type="text"
      id="name"
      name="name"
      class="form-input"
      required
      aria-required="true"
      autocomplete="name"
    />
    <span class="form-error" id="name-error" role="alert"></span>
  </div>

  <div class="form-group">
    <label for="email" class="form-label">
      E-Mail <span class="required">*</span>
    </label>
    <input
      type="email"
      id="email"
      name="email"
      class="form-input"
      required
      aria-required="true"
      autocomplete="email"
    />
    <span class="form-error" id="email-error" role="alert"></span>
  </div>

  <div class="form-group">
    <label for="phone" class="form-label">
      Telefon <span class="optional">(optional)</span>
    </label>
    <input
      type="tel"
      id="phone"
      name="phone"
      class="form-input"
      autocomplete="tel"
    />
    <span class="form-error" id="phone-error" role="alert"></span>
  </div>

  <div class="form-group">
    <label for="message" class="form-label">
      Nachricht <span class="required">*</span>
    </label>
    <textarea
      id="message"
      name="message"
      class="form-input form-textarea"
      rows="6"
      required
      aria-required="true"
    ></textarea>
    <span class="form-error" id="message-error" role="alert"></span>
  </div>

  <!-- Honeypot Field (unsichtbar für echte Nutzer) -->
  <div class="form-group honeypot" aria-hidden="true">
    <label for="company_website" class="sr-only">Website</label>
    <input
      type="text"
      id="company_website"
      name="company_website"
      tabindex="-1"
      autocomplete="off"
    />
  </div>

  <!-- Privacy Checkbox -->
  <div class="form-group">
    <label class="form-checkbox">
      <input
        type="checkbox"
        id="privacy"
        name="privacy"
        required
        aria-required="true"
      />
      <span>
        Ich habe die <a href="/datenschutz" target="_blank">Datenschutzerklärung</a> gelesen und stimme zu. <span class="required">*</span>
      </span>
    </label>
    <span class="form-error" id="privacy-error" role="alert"></span>
  </div>

  <!-- Cloudflare Turnstile -->
  {turnstileSiteKey && (
    <div class="form-group">
      <div
        class="cf-turnstile"
        data-sitekey={turnstileSiteKey}
        data-callback="onTurnstileSuccess"
        data-error-callback="onTurnstileError"
        id="turnstile-widget"
      ></div>
      <span class="form-error" id="turnstile-error" role="alert"></span>
    </div>
  )}

  <!-- Status Messages -->
  <div class="form-status" id="form-status" role="alert" aria-live="polite"></div>

  <button type="submit" class="btn btn-primary btn-large" id="submit-btn">
    Nachricht senden
  </button>
</form>

<style>
  .contact-form {
    max-width: 600px;
    margin: 0 auto;
  }

  .form-group {
    margin-bottom: var(--spacing-lg);
  }

  .form-label {
    display: block;
    margin-bottom: var(--spacing-sm);
    font-weight: var(--font-weight-medium);
    color: var(--color-text);
  }

  .required {
    color: var(--color-error);
  }

  .optional {
    color: var(--color-text-muted);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-normal);
  }

  .form-input,
  .form-textarea {
    width: 100%;
    padding: var(--spacing-md);
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius-md);
    font-size: var(--font-size-base);
    font-family: var(--font-family-base);
    transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
    background-color: var(--color-bg);
    color: var(--color-text);
  }

  .form-input:focus,
  .form-textarea:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }

  .form-input:invalid:not(:focus):not(:placeholder-shown),
  .form-textarea:invalid:not(:focus):not(:placeholder-shown) {
    border-color: var(--color-error);
  }

  .form-textarea {
    resize: vertical;
    min-height: 120px;
  }

  .form-error {
    display: block;
    color: var(--color-error);
    font-size: var(--font-size-sm);
    margin-top: var(--spacing-xs);
    min-height: 1.25rem;
  }

  .form-checkbox {
    display: flex;
    align-items: flex-start;
    gap: var(--spacing-sm);
    cursor: pointer;
  }

  .form-checkbox input[type="checkbox"] {
    margin-top: 0.25rem;
    flex-shrink: 0;
    cursor: pointer;
  }

  .form-checkbox span {
    color: var(--color-text-light);
    font-size: var(--font-size-sm);
  }

  .form-checkbox a {
    text-decoration: underline;
  }

  .honeypot {
    position: absolute;
    left: -9999px;
    opacity: 0;
    pointer-events: none;
  }

  .form-status {
    padding: var(--spacing-md);
    border-radius: var(--border-radius-md);
    margin-bottom: var(--spacing-lg);
    display: none;
  }

  .form-status.success {
    display: block;
    background-color: rgba(16, 185, 129, 0.1);
    color: var(--color-success);
    border: 1px solid var(--color-success);
  }

  .form-status.error {
    display: block;
    background-color: rgba(239, 68, 68, 0.1);
    color: var(--color-error);
    border: 1px solid var(--color-error);
  }

  #submit-btn {
    width: 100%;
  }

  #submit-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  /* Turnstile Container */
  .cf-turnstile {
    margin-bottom: var(--spacing-md);
  }
</style>

<script>
  // Turnstile Callbacks
  let turnstileToken = '';

  window.onTurnstileSuccess = (token: string) => {
    turnstileToken = token;
    const errorEl = document.getElementById('turnstile-error');
    if (errorEl) {
      errorEl.textContent = '';
    }
  };

  window.onTurnstileError = () => {
    turnstileToken = '';
    const errorEl = document.getElementById('turnstile-error');
    if (errorEl) {
      errorEl.textContent = 'Bitte bestätigen Sie, dass Sie kein Roboter sind.';
    }
  };

  // Form Handling
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('contact-form') as HTMLFormElement;
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
    const statusEl = document.getElementById('form-status') as HTMLDivElement;

    if (!form || !submitBtn || !statusEl) return;

    // Clear status on input
    const inputs = form.querySelectorAll('input, textarea');
    inputs.forEach((input) => {
      input.addEventListener('input', () => {
        clearStatus();
        clearFieldError(input as HTMLElement);
      });
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearStatus();
      clearAllErrors();

      // Validate form
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      // Check Turnstile
      const turnstileSiteKey = import.meta.env.PUBLIC_TURNSTILE_SITE_KEY;
      if (turnstileSiteKey && !turnstileToken) {
        showError('turnstile-error', 'Bitte bestätigen Sie, dass Sie kein Roboter sind.');
        return;
      }

      // Disable submit button
      submitBtn.disabled = true;
      submitBtn.textContent = 'Wird gesendet...';

      try {
        // Get form data
        const formData = new FormData(form);
        const data = {
          name: formData.get('name'),
          email: formData.get('email'),
          phone: formData.get('phone') || '',
          message: formData.get('message'),
          company_website: formData.get('company_website'), // Honeypot
          privacy: formData.get('privacy') === 'on',
          turnstile_token: turnstileToken,
        };

        // Send to API
        const response = await fetch('/api/contact', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data),
        });

        const result = await response.json();

        if (result.ok) {
          showSuccess('Vielen Dank! Ihre Nachricht wurde erfolgreich gesendet. Wir melden uns schnellstmöglich bei Ihnen.');
          form.reset();
          turnstileToken = '';
          // Reset Turnstile widget
          if (window.turnstile) {
            const widgetId = document.getElementById('turnstile-widget')?.getAttribute('data-widget-id');
            if (widgetId) {
              window.turnstile.reset(widgetId);
            }
          }
        } else {
          showError('form-status', result.error || 'Ein Fehler ist aufgetreten. Bitte versuchen Sie es erneut.');
        }
      } catch (error) {
        console.error('Form submission error:', error);
        showError('form-status', 'Ein Fehler ist aufgetreten. Bitte versuchen Sie es erneut oder kontaktieren Sie uns direkt per E-Mail.');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Nachricht senden';
      }
    });
  });

  function clearStatus() {
    const statusEl = document.getElementById('form-status');
    if (statusEl) {
      statusEl.className = 'form-status';
      statusEl.textContent = '';
      statusEl.style.display = 'none';
    }
  }

  function clearAllErrors() {
    const errorEls = document.querySelectorAll('.form-error');
    errorEls.forEach((el) => {
      el.textContent = '';
    });
  }

  function clearFieldError(input: HTMLElement) {
    const name = (input as HTMLInputElement).name;
    const errorEl = document.getElementById(`${name}-error`);
    if (errorEl) {
      errorEl.textContent = '';
    }
  }

  function showError(elementId: string, message: string) {
    const errorEl = document.getElementById(elementId);
    if (errorEl) {
      errorEl.textContent = message;
    }
  }

  function showSuccess(message: string) {
    const statusEl = document.getElementById('form-status');
    if (statusEl) {
      statusEl.className = 'form-status success';
      statusEl.textContent = message;
      statusEl.style.display = 'block';
      statusEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
  }

  function showErrorStatus(message: string) {
    const statusEl = document.getElementById('form-status');
    if (statusEl) {
      statusEl.className = 'form-status error';
      statusEl.textContent = message;
      statusEl.style.display = 'block';
      statusEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
  }
</script>

<!-- Cloudflare Turnstile Script -->
{import.meta.env.PUBLIC_TURNSTILE_SITE_KEY && (
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
)}
